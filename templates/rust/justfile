# Advent of Code Solution
# Commands auto-detect Nix shell and use local tools when available

# Get current system (e.g., x86_64-linux, aarch64-darwin)
system := `nix eval --impure --raw --expr 'builtins.currentSystem'`

# Detect if we should use Nix or local commands
# Use Nix if: JUST_FORCE_NIX is set, OR we're not in the correct shell
force_nix := env_var_or_default('JUST_FORCE_NIX', '')
shell_root := env_var_or_default('AOC_NIX_SHELL_ROOT', '')
use_nix := if force_nix != '' { 'true' } else { if shell_root == justfile_directory() { 'false' } else { 'true' } }

# Build the solution
build:
    {{ if use_nix == 'true' { 'nix build' } else { 'cargo build --release' } }}

# Run the main verification binary
run:
    {{ if use_nix == 'true' { 'nix run' } else { 'cargo run --release' } }}

# Run a specific part with input from stdin
run-part PART:
    {{ if use_nix == 'true' { 'nix run .#part{{PART}}' } else { 'cargo run --release --bin template-rust-part{{PART}}' } }}

# Format code (modifies files)
format:
    {{ if use_nix == 'true' { 'nix develop --command cargo fmt' } else { 'cargo fmt' } }}

# Run all checks (build + tests + lint) - always hermetic
check-all:
    nix flake check

# Run tests
check-test:
    {{ if use_nix == 'true' { 'nix build .#checks.{{system}}.test' } else { 'cargo test' } }}

# Run clippy lint
check-lint:
    {{ if use_nix == 'true' { 'nix build .#checks.{{system}}.lint' } else { 'cargo clippy -- -D warnings' } }}

# Check formatting without modifying files
check-format:
    {{ if use_nix == 'true' { 'nix build .#checks.{{system}}.format-check' } else { 'cargo fmt --check' } }}

# Clean build artifacts
clean:
    rm -rf target/ result

# Show detected environment mode (debug command)
show-env:
    @echo "JUST_FORCE_NIX: {{ force_nix }}"
    @echo "AOC_NIX_SHELL_ROOT: {{ shell_root }}"
    @echo "justfile_directory(): {{ justfile_directory() }}"
    @echo "Using Nix: {{ use_nix }}"
    @echo ""
    {{ if use_nix == 'true' { '@echo "Mode: Nix commands (reproducible builds)"' } else { '@echo "Mode: Local commands (fast iteration)"' } }}
