# Advent of Code Solution
# Commands auto-detect Nix shell and use local tools when available

# Get current system (e.g., x86_64-linux, aarch64-darwin)
system := `nix eval --impure --raw --expr 'builtins.currentSystem'`

# Detect if we should use Nix or local commands
# Use Nix if: JUST_FORCE_NIX is set, OR we're not in the correct shell
force_nix := env_var_or_default('JUST_FORCE_NIX', '')
shell_root := env_var_or_default('AOC_NIX_SHELL_ROOT', '')
use_nix := if force_nix != '' { 'true' } else { if shell_root == justfile_directory() { 'false' } else { 'true' } }

# Build the solution
build:
    {{ if use_nix == 'true' { 'nix build' } else { 'cmake -B build && cmake --build build' } }}

# Run the solution (optionally specify part1 or part2)
run PART='':
    #!/usr/bin/env bash
    set -euo pipefail
    if [ "{{ PART }}" = "" ]; then
        {{ if use_nix == 'true' { 'nix run' } else { './build/template-cpp' } }}
    else
        {{ if use_nix == 'true' { 'nix run .#template-cpp-{{PART}}' } else { './build/template-cpp-{{PART}}' } }}
    fi

# Format code (modifies files)
format:
    {{ if use_nix == 'true' { 'nix develop --command bash -c \'find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format -i\'' } else { 'find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format -i' } }}

# Run all checks (build + tests + format) - always hermetic
check-all:
    nix flake check

# Run tests
check-test:
    {{ if use_nix == 'true' { 'nix build .#checks.{{system}}.test' } else { 'ctest --test-dir build' } }}

# Check formatting without modifying files
check-format:
    {{ if use_nix == 'true' { 'nix build .#checks.{{system}}.format-check' } else { 'find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run -Werror' } }}

# Clean build artifacts
clean:
    rm -rf result* build/ CMakeCache.txt CMakeFiles/ cmake_install.cmake Makefile

# Show detected environment mode (debug command)
show-env:
    @echo "JUST_FORCE_NIX: {{ force_nix }}"
    @echo "AOC_NIX_SHELL_ROOT: {{ shell_root }}"
    @echo "justfile_directory(): {{ justfile_directory() }}"
    @echo "Using Nix: {{ use_nix }}"
    @echo ""
    {{ if use_nix == 'true' { '@echo "Mode: Nix commands (reproducible builds)"' } else { '@echo "Mode: Local commands (fast iteration)"' } }}
