#!/usr/bin/env bash
# This .envrc file reads the selected flake from .flake-selection
# and loads the environment for that flake using nix-direnv.

FLAKE_SELECTION_FILE=".flake-selection"

# Check if the flake selection file exists
if [ ! -f "$FLAKE_SELECTION_FILE" ]; then
    echo "Warning: $FLAKE_SELECTION_FILE not found. Using default (templates/python)"
    SELECTED_FLAKE="templates/python"
else
    # Read the selected flake path from the file
    SELECTED_FLAKE=$(cat "$FLAKE_SELECTION_FILE" | tr -d '[:space:]')
fi

# Validate that the selected flake exists
if [ ! -d "$SELECTED_FLAKE" ]; then
    echo "Error: Selected flake directory '$SELECTED_FLAKE' does not exist"
    return 1
fi

if [ ! -f "$SELECTED_FLAKE/flake.nix" ]; then
    echo "Error: No flake.nix found in '$SELECTED_FLAKE'"
    return 1
fi

echo "Loading environment from flake: $SELECTED_FLAKE"

# Use nix-direnv to load the flake environment
use flake "./$SELECTED_FLAKE"
